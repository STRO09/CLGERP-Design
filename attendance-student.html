<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Student Dashboard - College ERP</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark"
      style="background-color: #0c2562"
    >
      <div class="container-fluid">
        <a class="navbar-brand" href="#">College ERP</a>
        <div class="d-flex">
          <a href="login.html?role=student" class="btn btn-outline-light"
            >Logout</a
          >
        </div>
      </div>
    </nav>

    <!-- ‚úÖ Sidebar + Content Wrapper -->
    <div class="d-flex flex-grow-1">
      <!-- ‚úÖ Sidebar -->
      <div class="sidebar d-flex flex-column">
        <hr class="bg-light" />
        <a href="student-dashboard.html" onclick="showAlert('Attendance: 92%')"
          >üè† Dashboard</a
        >
        <a
          href="#"
          style="border: thin solid white"
          onclick="showAlert('Attendance: 92%')"
          >üìä Attendance</a
        >
        <a
          href="announcements-student.html"
          onclick="showAlert('No new announcements.')"
          >üì¢ Announcements</a
        >
        <a
          href="timetable-student.html"
          onclick="showAlert('Monday: Math, Tuesday: Physics...')"
          >üìÖ Timetable</a
        >
        <a
          href="results-student.html"
          onclick="showAlert('Results: Math: 85, Physics: 90')"
          >üìú Results</a
        >

        <hr class="bg-light" />
        <a href="#" onclick="showAlert('Attendance grace request submitted!')"
          >‚úÖ Request Attendance Grace</a
        >
        <a
          href="#"
          onclick="showAlert('ID card replacement request submitted!')"
          >üÜî ID Card Replacement</a
        >
      </div>

      <div class="container mt-4 px-5">
        <h2 class="mt-2 mb-5 text-center">Student Attendance</h2>

        <div id="calendar"></div>
        <!-- Attendance Sidebar -->
        <div id="attendanceSidebar">
          <div class="sidebar-header">
            <h4 id="sidebarDate">Date</h4>
            <button id="closeSidebar" class="btn btn-sm btn-light">√ó</button>
          </div>
          <div id="attendanceContent">
            <!-- We'll fill this with JS -->
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const calendarEl = document.getElementById("calendar");

        // Modal elements
        const modal = document.getElementById("eventModal");
        const modalTitle = document.getElementById("modalTitle");
        const eventTitleInput = document.getElementById("eventTitle");
        const startDateTimeInput = document.getElementById("startDateTime");
        const endDateTimeInput = document.getElementById("endDateTime");
        const saveBtn = document.getElementById("saveEventBtn");
        const deleteBtn = document.getElementById("deleteEventBtn");
        const cancelBtn = document.getElementById("cancelBtn");

        let selectedDate = null;
        let selectedEvent = null;

        // Load saved events
        let myEvents = JSON.parse(localStorage.getItem("myEvents")) || [];

        // ‚úÖ FullCalendar setup
        let calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          height: "100%",
          events: myEvents,
          editable: true,

          dateClick: function (info) {
            // Example: Pretend this is your attendance data
            const dummyAttendance = {
              "2025-08-10": "Present",
              "2025-08-09": "Absent",
              "2025-08-08": "Late",
            };

            const dateStr = info.dateStr;
            document.getElementById("sidebarDate").textContent = dateStr;

            const status = dummyAttendance[dateStr] || "No record";
            document.getElementById("attendanceContent").innerHTML = `
    <p><strong>Status:</strong> ${status}</p>
  `;

            document.getElementById("attendanceSidebar").classList.add("open");

            document
              .getElementById("closeSidebar")
              .addEventListener("click", function () {
                document
                  .getElementById("attendanceSidebar")
                  .classList.remove("open");
              });
          },

          eventClick: function (info) {
            selectedEvent = info.event;

            modalTitle.textContent = "Edit Event";
            eventTitleInput.value = info.event.title;

            // Format dates for datetime-local input
            const formatDateTime = (d) => {
              if (!d) return "";
              const pad = (n) => (n < 10 ? "0" + n : n);
              const yyyy = d.getFullYear();
              const mm = pad(d.getMonth() + 1);
              const dd = pad(d.getDate());
              const hh = pad(d.getHours());
              const min = pad(d.getMinutes());
              return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
            };

            startDateTimeInput.value = formatDateTime(info.event.start);
            endDateTimeInput.value = info.event.end
              ? formatDateTime(info.event.end)
              : "";

            deleteBtn.style.display = "inline-block";
            openModal();
          },
        });

        calendar.render();

        // ‚úÖ Open modal
        function openModal() {
          modal.style.display = "flex";
          eventTitleInput.focus();
        }

        // ‚úÖ Close modal
        function closeModal() {
          modal.style.display = "none";
          selectedDate = null;
          selectedEvent = null;
        }

        function generateId() {
          return "ev-" + Math.random().toString(36).substr(2, 9);
        }
        // ‚úÖ Save or update event
        saveBtn.onclick = function () {
          const title = eventTitleInput.value.trim();
          const start = startDateTimeInput.value
            ? new Date(startDateTimeInput.value).toISOString()
            : null;
          const end = endDateTimeInput.value
            ? new Date(endDateTimeInput.value).toISOString()
            : null;

          if (!title || !start) {
            alert("Title and Start date are required!");
            return;
          }

          if (selectedEvent) {
            // Editing existing event
            const oldTitle = selectedEvent.title;

            selectedEvent.setProp("title", title);
            selectedEvent.setStart(start);
            selectedEvent.setEnd(end);

            myEvents = myEvents.map((ev) =>
              ev.id === selectedEvent.id
                ? { ...ev, title, start, end, id: ev.id }
                : ev
            );
          } else {
            // Adding new event
            const newEvent = { id: generateId(), title, start, end };
            myEvents.push(newEvent);
            calendar.addEvent(newEvent);
          }

          localStorage.setItem("myEvents", JSON.stringify(myEvents));
          closeModal();
        };

        // ‚úÖ Delete event
        deleteBtn.onclick = function () {
          if (selectedEvent) {
            if (confirm("Delete this event?")) {
              selectedEvent.remove();
              myEvents = myEvents.filter((ev) => ev.id !== selectedEvent.id);
              localStorage.setItem("myEvents", JSON.stringify(myEvents));
              closeModal();
            }
          }
        };

        // ‚úÖ Cancel button
        cancelBtn.onclick = closeModal;

        // ‚úÖ Close modal if click outside content
        modal.addEventListener("click", function (e) {
          if (e.target === modal) closeModal();
        });
      });
    </script>
  </body>
</html>
